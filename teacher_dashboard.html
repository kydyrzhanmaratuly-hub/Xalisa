<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É—á–∏—Ç–µ–ª—è</title>
    <link rel="stylesheet" href="Teacher_Grades.css">
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üë®‚Äçüè´ –ü–∞–Ω–µ–ª—å —É—á–∏—Ç–µ–ª—è</h1>
            <div class="user-info">
                <p><strong id="teacherName">–ó–∞–≥—Ä—É–∑–∫–∞...</strong></p>
                <p>–ì—Ä—É–ø–ø–∞: <span id="teacherGroup">---</span></p>
                <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <h3>–í—Å–µ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h3>
                <div class="number" id="totalStudents">0</div>
            </div>
            <div class="stat-card">
                <h3>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –≥—Ä—É–ø–ø—ã</h3>
                <div class="number" id="avgGrade">0</div>
            </div>
            <div class="stat-card">
                <h3>–ü—Ä–µ–¥–º–µ—Ç–æ–≤</h3>
                <div class="number" id="totalSubjects">0</div>
            </div>
        </div>

        <div class="main-card">
            <h2>üìä –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∞–º–∏</h2>
            
            <div class="success-message" id="successMessage">
                –û—Ü–µ–Ω–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label>–ü—Ä–µ–¥–º–µ—Ç</label>
                    <select id="subjectFilter">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç...</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>–ü–æ–∏—Å–∫ —Å—Ç—É–¥–µ–Ω—Ç–∞</label>
                    <input type="text" id="studentSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Å—Ç—É–¥–µ–Ω—Ç–∞...">
                </div>
            </div>

            <div id="loadingArea" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            <div id="noDataArea" class="no-data" style="display: none;">
                –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            </div>

            <div id="tableArea" style="display: none;">
                <table class="students-table">
                    <thead>
                        <tr>
                            <th>–°—Ç—É–¥–µ–Ω—Ç</th>
                            <th>–õ–æ–≥–∏–Ω</th>
                            <th>–¢–µ–∫—É—â–∞—è –æ—Ü–µ–Ω–∫–∞</th>
                            <th>–ù–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ (0-100)</th>
                            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let teacherData = null;
        let studentsData = [];
        let gradesData = {};
        let teacherDashLabels = {
            saveButton: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'
        };

        const teacherDashTranslations = {
            RU: {
                header: 'üë®‚Äçüè´ –ü–∞–Ω–µ–ª—å —É—á–∏—Ç–µ–ª—è',
                groupLabel: '–ì—Ä—É–ø–ø–∞:',
                logout: '–í—ã–π—Ç–∏',
                stat_totalStudents: '–í—Å–µ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤',
                stat_avgGrade: '–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –≥—Ä—É–ø–ø—ã',
                stat_totalSubjects: '–ü—Ä–µ–¥–º–µ—Ç–æ–≤',
                mainTitle: 'üìä –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∞–º–∏',
                successSaved: '–û—Ü–µ–Ω–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!',
                filter_subject: '–ü—Ä–µ–¥–º–µ—Ç',
                filter_search: '–ü–æ–∏—Å–∫ —Å—Ç—É–¥–µ–Ω—Ç–∞',
                choose_subject: '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç...',
                search_placeholder: '–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Å—Ç—É–¥–µ–Ω—Ç–∞...',
                loading: '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...',
                noData: '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤',
                table_headers: ['–°—Ç—É–¥–µ–Ω—Ç', '–õ–æ–≥–∏–Ω', '–¢–µ–∫—É—â–∞—è –æ—Ü–µ–Ω–∫–∞', '–ù–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ (0-100)', '–î–µ–π—Å—Ç–≤–∏–µ'],
                saveButton: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'
            },
            KZ: {
                header: 'üë®‚Äçüè´ “∞—Å—Ç–∞–∑ –ø–∞–Ω–µ–ª—ñ',
                groupLabel: '–¢–æ–ø:',
                logout: '–®—ã“ì—É',
                stat_totalStudents: '–û“õ—É—à—ã–ª–∞—Ä —Å–∞–Ω—ã',
                stat_avgGrade: '–¢–æ–ø—Ç—ã“£ –æ—Ä—Ç–∞—à–∞ –±–∞“ì–∞—Å—ã',
                stat_totalSubjects: '–ü”ô–Ω–¥–µ—Ä',
                mainTitle: 'üìä –ë–∞“ì–∞–ª–∞—Ä–¥—ã –±–∞—Å“õ–∞—Ä—É',
                successSaved: '–ë–∞“ì–∞–ª–∞—Ä —Å”ô—Ç—Ç—ñ —Å–∞“õ—Ç–∞–ª–¥—ã!',
                filter_subject: '–ü”ô–Ω',
                filter_search: '–°—Ç—É–¥–µ–Ω—Ç—Ç—ñ —ñ–∑–¥–µ—É',
                choose_subject: '–ü”ô–Ω–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑...',
                search_placeholder: '–°—Ç—É–¥–µ–Ω—Ç—Ç—ñ“£ –∞—Ç—ã–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑...',
                loading: '–î–µ—Ä–µ–∫—Ç–µ—Ä –∂“Ø–∫—Ç–µ–ª—É–¥–µ...',
                noData: '–°—Ç—É–¥–µ–Ω—Ç—Ç–µ—Ä–¥—ñ –∫”©—Ä—Å–µ—Ç—É “Ø—à—ñ–Ω –ø”ô–Ω–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑',
                table_headers: ['–°—Ç—É–¥–µ–Ω—Ç', '–õ–æ–≥–∏–Ω', '–ê“ì—ã–º–¥–∞“ì—ã –±–∞“ì–∞', '–ñ–∞“£–∞ –±–∞“ì–∞ (0-100)', '”ò—Ä–µ–∫–µ—Ç'],
                saveButton: '–°–∞“õ—Ç–∞—É'
            },
            EN: {
                header: 'üë®‚Äçüè´ Teacher Dashboard',
                groupLabel: 'Group:',
                logout: 'Logout',
                stat_totalStudents: 'Total students',
                stat_avgGrade: 'Group average grade',
                stat_totalSubjects: 'Subjects',
                mainTitle: 'üìä Grades management',
                successSaved: 'Grades saved successfully!',
                filter_subject: 'Subject',
                filter_search: 'Search student',
                choose_subject: 'Choose a subject...',
                search_placeholder: 'Enter student name...',
                loading: 'Loading data...',
                noData: 'Select a subject to show students',
                table_headers: ['Student', 'Login', 'Current grade', 'New grade (0-100)', 'Action'],
                saveButton: 'Save'
            }
        };

        function applyDashboardLang(lang) {
            const L = teacherDashTranslations[lang] || teacherDashTranslations.RU;
            // Header
            const headerH1 = document.querySelector('.header-content h1');
            if (headerH1) headerH1.textContent = L.header;
            // Group label (preserve span)
            const groupSpan = document.getElementById('teacherGroup');
            if (groupSpan) {
                const parentP = groupSpan.parentElement;
                parentP.innerHTML = `${L.groupLabel} <span id="teacherGroup">${groupSpan.textContent}</span>`;
            }
            // Logout button
            const logoutBtn = document.querySelector('.logout-btn');
            if (logoutBtn) logoutBtn.textContent = L.logout;
            // Stats titles
            const statH3 = document.querySelectorAll('.stats-grid .stat-card h3');
            if (statH3 && statH3.length >= 3) {
                statH3[0].textContent = L.stat_totalStudents;
                statH3[1].textContent = L.stat_avgGrade;
                statH3[2].textContent = L.stat_totalSubjects;
            }
            // Main title
            const mainH2 = document.querySelector('.main-card h2');
            if (mainH2) mainH2.textContent = L.mainTitle;
            // Success message
            const successMsg = document.getElementById('successMessage');
            if (successMsg) successMsg.textContent = L.successSaved;
            // Filters
            const filterLabels = document.querySelectorAll('.filters .filter-group label');
            if (filterLabels && filterLabels.length >= 2) {
                filterLabels[0].textContent = L.filter_subject;
                filterLabels[1].textContent = L.filter_search;
            }
            // Subject select placeholder
            const subjectSelect = document.getElementById('subjectFilter');
            if (subjectSelect) {
                if (subjectSelect.options && subjectSelect.options.length > 0) {
                    subjectSelect.options[0].text = L.choose_subject;
                }
            }
            // Search placeholder
            const studentSearch = document.getElementById('studentSearch');
            if (studentSearch) studentSearch.placeholder = L.search_placeholder;
            // Loading and no data
            const loadingArea = document.getElementById('loadingArea');
            if (loadingArea) loadingArea.textContent = L.loading;
            const noDataArea = document.getElementById('noDataArea');
            if (noDataArea) noDataArea.textContent = L.noData;
            // Table headers
            const ths = document.querySelectorAll('.students-table thead th');
            if (ths && ths.length === L.table_headers.length) {
                ths.forEach((th, i) => th.textContent = L.table_headers[i]);
            }
            // Save button label for dynamically created rows
            teacherDashLabels.saveButton = L.saveButton;
            try { localStorage.setItem('currentLanguage', lang); } catch (e) {}
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        document.addEventListener('DOMContentLoaded', async () => {
            // Apply language from URL or storage
            const params = new URLSearchParams(window.location.search);
            const urlLang = params.get('lang');
            const lang = urlLang || localStorage.getItem('currentLanguage') || 'RU';
            applyDashboardLang(lang);
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            const teacherDataStr = localStorage.getItem('teacherData');
            if (!teacherDataStr) {
                    const lang = localStorage.getItem('currentLanguage') || 'RU';
                    window.location.href = `teacher_login.html?lang=${lang}`;
                    return;
                }

            teacherData = JSON.parse(teacherDataStr);
            document.getElementById('teacherName').textContent = teacherData.fullName;
            document.getElementById('teacherGroup').textContent = teacherData.group;

            await loadData();
        });

        async function loadData() {
            try {
                // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã
                const scheduleRes = await fetch(`http://localhost:3000/api/schedule/${encodeURIComponent(teacherData.group)}`);
                const scheduleData = await scheduleRes.json();
                
                // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã
                const subjects = [...new Set(scheduleData.schedule.map(item => item.subject))];
                document.getElementById('totalSubjects').textContent = subjects.length;

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
                const subjectFilter = document.getElementById('subjectFilter');
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectFilter.appendChild(option);
                });

                // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≥—Ä—É–ø–ø—ã
                const studentsRes = await fetch(`http://localhost:3000/api/students/${encodeURIComponent(teacherData.group)}`);
                studentsData = await studentsRes.json();
                document.getElementById('totalStudents').textContent = studentsData.length;

                // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫
                const gradesRes = await fetch(`http://localhost:3000/api/grades/${encodeURIComponent(teacherData.group)}`);
                gradesData = await gradesRes.json();

                calculateAvgGrade();

                document.getElementById('loadingArea').style.display = 'none';
                document.getElementById('noDataArea').style.display = 'block';

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                document.getElementById('loadingArea').innerHTML = 
                    '<div style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É.</div>';
            }
        }

        // –§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É
        document.getElementById('subjectFilter').addEventListener('change', (e) => {
            const subject = e.target.value;
            if (subject) {
                displayStudents(subject);
            } else {
                document.getElementById('tableArea').style.display = 'none';
                document.getElementById('noDataArea').style.display = 'block';
            }
        });

        // –ü–æ–∏—Å–∫ —Å—Ç—É–¥–µ–Ω—Ç–∞
        document.getElementById('studentSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#studentsTableBody tr');
            
            rows.forEach(row => {
                const studentName = row.cells[0].textContent.toLowerCase();
                row.style.display = studentName.includes(searchTerm) ? '' : 'none';
            });
        });

        function displayStudents(subject) {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';

            studentsData.forEach(student => {
                const currentGrade = gradesData[student.login]?.[subject] || 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.login}</td>
                    <td><strong>${currentGrade}</strong></td>
                    <td>
                        <input type="number" 
                               class="grade-input" 
                               min="0" 
                               max="100" 
                               value="${currentGrade}"
                               data-student="${student.login}"
                               data-subject="${subject}">
                    </td>
                    <td>
                        <button class="save-btn" onclick="saveGrade('${student.login}', '${subject}')">
                            ${teacherDashLabels.saveButton}
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('noDataArea').style.display = 'none';
            document.getElementById('tableArea').style.display = 'block';
        }

        async function saveGrade(studentLogin, subject) {
            const input = document.querySelector(`input[data-student="${studentLogin}"][data-subject="${subject}"]`);
            const grade = parseInt(input.value);

            if (grade < 0 || grade > 100) {
                alert('–û—Ü–µ–Ω–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 0 –¥–æ 100');
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/api/save-grade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        studentLogin,
                        subject,
                        grade,
                        group: teacherData.group
                    })
                });

                if (response.ok) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    if (!gradesData[studentLogin]) gradesData[studentLogin] = {};
                    gradesData[studentLogin][subject] = grade;

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                    const successMsg = document.getElementById('successMessage');
                    successMsg.style.display = 'block';
                    setTimeout(() => {
                        successMsg.style.display = 'none';
                    }, 3000);

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª
                    calculateAvgGrade();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                    displayStudents(subject);
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        }

        function calculateAvgGrade() {
            let total = 0;
            let count = 0;

            Object.values(gradesData).forEach(studentGrades => {
                Object.values(studentGrades).forEach(grade => {
                    total += grade;
                    count++;
                });
            });

            const avg = count > 0 ? (total / count).toFixed(1) : 0;
            document.getElementById('avgGrade').textContent = avg;
        }

        function logout() {
            localStorage.removeItem('teacherData');
                const lang = localStorage.getItem('currentLanguage') || 'RU';
                window.location.href = `teacher_login.html?lang=${lang}`;
        }
    </script>
</body>
</html>